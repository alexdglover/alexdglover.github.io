I"Ô"<p>I did it. The one universalÂ rule when it comes to source control/Git, and I broke it. I committed my OAuth key for my <a href="http://www.alexdglover.com/youpassbutter-slack-bot-part-1/" target="_blank">YouPassButter Slack app</a>Â to GitHub. Thankfully it was only a personal project, and not anything more important than that. Either way, I got a little spooked and wanted to go through the process of removing sensitive data from GitHub as a learning opportunity.
Before we get started on the walk-through, there are two things Iâ€™d like to mention upfront:</p>

<ul>
  <li>Because of the distributed nature of Git, if someone cloned or forked your repo while it contained sensitive data, that data is compromised. There is no way to delete your data out of someone elseâ€™s repo</li>
  <li>I will be following <a href="https://help.github.com/articles/removing-sensitive-data-from-a-repository/">GitHubâ€™s published process</a> using the â€˜git filter-branchâ€™ command. Iâ€™m mostly documentingÂ this for my own future reference, and as a quasi-punishment for myself to emphasize the importance of not committing keys in the future (I could write â€œDonâ€™t commit keys to GitHubâ€Â 1000 times on a blackboard, but thisÂ seems more productive)</li>
</ul>

<h2>Process</h2>

<ol>
  <li>If you donâ€™t already have the repo cloned locally, do that first, then â€˜cdâ€™ into your repo directory.</li>
  <li>
    <p>In my case, the sensitive data was in the â€˜app.rbâ€™ file in the root of my project repo. Before you execute this next command, be aware that <strong>it will delete the local copy of the file</strong>Â along with updating all of the commits in your commit history. You probablyÂ want to save a copy of your file somewhere before running this. With that in mind, letâ€™s execute the â€˜git filter-branchâ€™ command and look at the output:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>alexdglover@host:~/Documents/workspace/rick-and-morty-bot] <span class="nv">$ </span>git filter-branch <span class="nt">--force</span> <span class="nt">--index-filter</span> <span class="se">\</span>
<span class="o">&gt;</span> <span class="s1">'git rm --cached --ignore-unmatch app.rb'</span> <span class="se">\</span>
<span class="o">&gt;</span> <span class="nt">--prune-empty</span> <span class="nt">--tag-name-filter</span> <span class="nb">cat</span> <span class="nt">--</span> <span class="nt">--all</span>
Rewrite c6a89ccf770fe1745259af4dd5c1de740a8c2a1e <span class="o">(</span>1/75<span class="o">)</span> <span class="o">(</span>0 seconds passed, remaining 0 predicted<span class="o">)</span>    <span class="nb">rm</span> <span class="s1">'app.rb'</span>
Rewrite 17e90caa961fa7b801701abfbae9ce0c34a2a9d1 <span class="o">(</span>2/75<span class="o">)</span> <span class="o">(</span>0 seconds passed, remaining 0 predicted<span class="o">)</span>    <span class="nb">rm</span> <span class="s1">'app.rb'</span>
Rewrite ec633eb63f1c7eead43157e100006029cf8029a6 <span class="o">(</span>3/75<span class="o">)</span> <span class="o">(</span>0 seconds passed, remaining 0 predicted<span class="o">)</span>    <span class="nb">rm</span> <span class="s1">'app.rb'</span>
...
Rewrite c4d38d45a710b7e87c2d75820fe65d204f9014e1 <span class="o">(</span>39/75<span class="o">)</span> <span class="o">(</span>1 seconds passed, remaining 0 predicted<span class="o">)</span>    <span class="nb">rm</span> <span class="s1">'app.rb'</span>
Rewrite d2b25cdd3e6190b2d59c1239d5955245c76a173b <span class="o">(</span>39/75<span class="o">)</span> <span class="o">(</span>1 seconds passed, remaining 0 predicted<span class="o">)</span>    <span class="nb">rm</span> <span class="s1">'app.rb'</span>
Rewrite c4570086709c08364d769bcb1818c0a2631ea111 <span class="o">(</span>39/75<span class="o">)</span> <span class="o">(</span>1 seconds passed, remaining 0 predicted<span class="o">)</span>    <span class="nb">rm</span> <span class="s1">'app.rb'</span>

Ref <span class="s1">'refs/heads/master'</span> was rewritten
Ref <span class="s1">'refs/remotes/heroku/master'</span> was rewritten
WARNING: Ref <span class="s1">'refs/remotes/heroku/master'</span> is unchanged
Ref <span class="s1">'refs/remotes/origin/master'</span> was rewritten
<span class="o">[</span>alexdglover@host:~/Documents/workspace/rick-and-morty-bot] <span class="err">$</span>
</code></pre></div>    </div>

    <p>The command is going through each commit in theÂ commit history and deleting the file containing the sensitive data. So far, so good.</p>
  </li>
  <li>
    <p>Typically, in this step youâ€™d create a .gitignore file, add the offending file containing sensitive data to the .gitignore, and then re-commit everything. In my case, I canâ€™t add app.rb to .gitignore because itâ€™s the bulk of my code. Instead,Â letâ€™s try removing the credentials manually (and replacing it with environment variable references), saving that file into our repo, re-committing app.rb, and see what happens.</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>alexdglover@mobile1:~/Documents/workspace/rick-and-morty-bot]<span class="nv">$ </span>vim app.rb <span class="c"># I re-created the app.rb file without the sensitive data</span>
<span class="o">[</span>alexdglover@mobile1:~/Documents/workspace/rick-and-morty-bot]<span class="nv">$ </span>git status
On branch master
Your branch is up-to-date with <span class="s1">'origin/master'</span><span class="nb">.</span>
Untracked files:
  <span class="o">(</span>use <span class="s2">"git add &lt;file&gt;..."</span> to include <span class="k">in </span>what will be committed<span class="o">)</span>

  app.rb

nothing added to commit but untracked files present <span class="o">(</span>use <span class="s2">"git add"</span> to track<span class="o">)</span>
<span class="o">[</span>alexdglover@mobile1:~/Documents/workspace/rick-and-morty-bot]<span class="nv">$ </span>git add app.rb
<span class="o">[</span>alexdglover@mobile1:~/Documents/workspace/rick-and-morty-bot]<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s1">'adds app.rb back into repo after removing secrets'</span>
<span class="o">[</span>master 346e3e5] adds app.rb back into repo after removing secrets
 1 file changed, 202 insertions<span class="o">(</span>+<span class="o">)</span>
 create mode 100644 app.rb
<span class="o">[</span>alexdglover@mobile1:~/Documents/workspace/rick-and-morty-bot]<span class="nv">$ </span>git push
</code></pre></div>    </div>

    <p>You can see that Git thinks app.rb is aÂ <strong>completely</strong> new file, and is unaware that it ever existed. Another good sign.Â My â€˜git pushâ€™ had a minor merge conflict with my GitHub upstream repo, but was trivial. Now Iâ€™ve strayed slightly from GitHubâ€™s instructions, letâ€™s move on to the last step and see if this works.</p>
  </li>
  <li>
    <p>Finally, we need to execute â€˜git push origin â€“force â€“allâ€™ to overwrite our GitHub repository. Letâ€™s give it a try:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>alexdglover@mobile1:~/Documents/workspace/rick-and-morty-bot] <span class="nv">$ </span>git push origin <span class="nt">--force</span> <span class="nt">--all</span>
Everything up-to-date
</code></pre></div>    </div>

    <p>Wellâ€¦ that was a little anti-climactic. Iâ€™m assumingÂ my earlier push already overwrote GitHub. Letâ€™s take a look in GitHubâ€™s web UI and see if we can find any trace of our sensitive data.</p>

    <p><a href="http://i.imgur.com/MLwpwcA.png"><img class="aligncenter size-large" src="/assets/MLwpwcA.png" alt="GitHub - history for app.rb file" width="1146" height="475" /></a>
Excellent! I donâ€™t see the Slack client ID and secret in the code any more, and the commit history for that file only shows our most recent commit!</p>
  </li>
  <li>My repo isÂ very simple and didnâ€™t use any other tags or branches. If you committed a secret/key/password to your repo and you do useÂ tags, youâ€™ll also need to execute â€˜git push origin â€“force â€“tagsâ€™ to overwrite all of the tagged commits.</li>
</ol>

<h2>Post Cleanup Process</h2>

<p>If youâ€™re working with other developers, be sure to ask them to rebase (not merge) their local repos after youâ€™ve cleaned up the sensitive data, otherwise they may re-introduce bad code or commit history containing the bad code. If you havenâ€™t done so already, this would also be a good time to change any credentials that you think may have been compromised. In my case, I simply needed to generate a new OAuth client secret for my Slack app.</p>

<p>I hope this was a helpful demonstration, and rememberâ€¦</p>

<h1>DON'T PUT CREDENTIALS INTO SOURCE CONTROL</h1>
:ET