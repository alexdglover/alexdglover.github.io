I"2<p class="notice--warning"><strong>Be advised</strong> This post is quite old (26 Nov 2012) and any code may be out of date. Proceed with caution.</p>

<p>Ok, some quick background before we get started. Let's say you have a search bar in your PHP-based web site to help people find items, which ties back to your database. Behind your search bar is some code and a query, something like</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM ITEMS_TABLE WHERE ITEM_NAME LIKE"</span> <span class="mf">.</span> <span class="nv">$mySearchBarString</span> <span class="mf">.</span> <span class="s2">";"</span><span class="p">;</span>
</code></pre></div></div>
<p>So a user provides some string, like 'Xbox,' and it finds all items with 'Xbox' in the name. Lovely. But what if the user enters this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">blah</span><span class="p">;</span> <span class="k">SET</span> <span class="o">@</span><span class="n">tables</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="k">table_name</span><span class="p">)</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">tables</span> <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="p">;</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">tables</span> <span class="o">=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">'DROP TABLE '</span><span class="p">,</span> <span class="o">@</span><span class="n">tables</span><span class="p">);</span>
<span class="k">PREPARE</span> <span class="n">stmt1</span> <span class="k">FROM</span> <span class="o">@</span><span class="n">tables</span><span class="p">;</span>
<span class="k">EXECUTE</span> <span class="n">stmt1</span><span class="p">;</span>
<span class="k">DEALLOCATE</span> <span class="k">PREPARE</span> <span class="n">stmt1</span><span class="p">;</span>
</code></pre></div></div>

<p>For those who can't read SQL, here's the short version - an attacker just dropped ALL of your databases, in all schemas. Whoops. This is your face right now:</p>
<p style="text-align: center;"><a href="https://www.alexdglover.com/assets/rage-classic-l.png"><img class="aligncenter size-medium wp-image-241" title="rage-classic-l" alt="" src="/assets/rage-classic-l.png" width="300" height="244" /></a></p>
<p>We're not going to let this happen to us, because losing and replacing that data seems like a lot of work, and we all have better things to do than restore backups and try to explain data loss to end users.</p>
<p>Let's review some options.</p>
<h3>Escape Special Characters</h3>
<p>Good news - this is a super easy method in PHP. Bad news - it doesn't protect against all SQL injection attacks. To implement, simply pass your users' input through the mysql_real_escape_string function and assign it to a new variable. Then use that variable in your query. For example, let's assume a user has posted some input from a form, which we'll grab with the $_POST[x] variable:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$userInput</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="n">some_input</span><span class="p">]);</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM ITEMS_TABLE WHERE ITEM_NAME LIKE"</span> <span class="mf">.</span> <span class="nv">$userInput</span> <span class="mf">.</span><span class="s2">";"</span><span class="p">;</span>
</code></pre></div></div>

<p>Simple! However, mysql_real_escape_string was created primarily to sanitize inputs, not give 100% protection against SQL injection attacks. Clever attackers can input HTML into your database, setting you up for cross-site scripting attacks. mysql_real_escape_string also doesn't escape the percentage sign (%), the wildcard in SQL, leaving you vulnerable.</p>
<p>Just to be clear - don't use myql_escape_string, as it is also vulnerable to <a href="http://security.stackexchange.com/questions/9908/multibyte-character-exploits-php-mysql" target="_blank">multi-byte character attacks</a>. At the very least, use mysql_real_escape_string.</p>
<h3>MySQLi and Prepared Statements</h3>
<p>This post is already getting long-winded, so I'll be brief. Using prepared statements is a best practice for a boatload of reasons. The advantage is that you convert your users' string input into a parameter object. It is 100% immune to SQL injection, because the input isn't concatenated to the query, it's treated as an object. You can use either MySQLi or PDO prepared statements, both are acceptable. Here's a quick example of using MySQLi and prepared statements from my scratch-space website:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">//set database connection</span>
<span class="nv">$mysqli</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s2">"domain.com"</span><span class="p">,</span><span class="s2">"username"</span><span class="p">,</span><span class="s2">"password"</span><span class="p">,</span><span class="s2">"database_name"</span><span class="p">);</span>

<span class="c1">//open database connection; if connection fails, echo the mysql error</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$mysqli</span><span class="o">-&gt;</span><span class="n">connect_errno</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Failed to connect to MySQL: ("</span> <span class="mf">.</span> <span class="nv">$mysqli</span><span class="o">-&gt;</span><span class="n">connect_errno</span> <span class="mf">.</span> <span class="s2">") "</span> <span class="mf">.</span> <span class="nv">$mysqli</span><span class="o">-&gt;</span><span class="n">connect_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//check if there is an HTTP POST variable; if one exists, then we need to do the insert; otherwise, don't insert anything</span>
<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"orgName"</span><span class="p">]))</span> <span class="p">{</span>
  <span class="cm">/* Prepared statement, stage 1: prepare */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$mysqli</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"INSERT INTO appgen (orgName, motto, number, map, site, body) VALUES (?, ?, ?, ?, ?, ?)"</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Error while preparing statement"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/* Prepared statement, stage 2: bind and execute */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">bind_param</span><span class="p">(</span><span class="s2">"ssssss"</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="n">orgName</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="n">motto</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="n">map</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="n">body</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Binding parameters failed: ("</span> <span class="mf">.</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="mf">.</span> <span class="s2">") "</span> <span class="mf">.</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Execute failed: ("</span> <span class="mf">.</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="mf">.</span> <span class="s2">") "</span> <span class="mf">.</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Record added!');&lt;/script&gt;"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>I think most of the code is pretty straightforward, but one thing that tripped me up is the "bind_param" function. The first argument in quotes is actually the data types of all of the parameters you want to bind. Each letter, in sequential order, represents the datatype  of the corresponding parameter. There are only four supported datatypes, i for integer, d for double, s for string, and b for <a href="http://en.wikipedia.org/wiki/Binary_large_object" target="_blank">BLOB</a>. So, for example, if I wanted to prepare an insert statement to insert an integer primary key, a string name, a decimal price, and an image BLOB, my code would look something like this:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="mf">...</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$mysqli</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"INSERT INTO table (id, name, price, image) VALUES (?, ?, ?, ?)"</span><span class="p">)))</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Error while preparing statement"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Prepared statement, stage 2: bind and execute */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">bind_param</span><span class="p">(</span><span class="s2">"isdb"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"Xbox"</span><span class="p">,</span> <span class="mf">299.99</span><span class="p">,</span> <span class="n">image_binary</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Binding parameters failed: ("</span> <span class="mf">.</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="mf">.</span> <span class="s2">") "</span> <span class="mf">.</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="mf">...</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Also notice that the number of question marks should be the same as the number of parameters you are binding. The <a href="http://php.net/manual/en/mysqli.quickstart.prepared-statements.php" target="_blank">documentation at php.net</a> is pretty good, but not great. If you have any questions or issues with this, please feel free to leave a comment.</p>
<p>As always, hope this was helpful!</p>
:ET